name: Deploy to Cloudflare

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

env:
  CLOUDFLARE_SUBDOMAIN: zarbazan
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install worker dependencies
        run: npm install
        working-directory: worker

      - name: Build Worker
        run: npx vite build
        working-directory: worker

      - name: Deploy Worker
        run: npx wrangler deploy --config dist/overture_s3_proxy/wrangler.json
        working-directory: worker

      - name: Build frontend
        run: npm install && npm run build

      - name: Prepare deploy directory
        run: cp -r functions dist/

      - name: Create Pages project if needed
        run: npx wrangler pages project create overture-maps --production-branch=master 2>/dev/null || true

      - name: Deploy Pages (production)
        if: github.event_name == 'push'
        run: npx wrangler pages deploy dist --project-name=overture-maps --commit-dirty=true

      - name: Deploy Pages (preview)
        if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
        run: npx wrangler pages deploy dist --project-name=overture-maps --commit-dirty=true --branch=${{ github.head_ref }}

      - name: Comment preview URL on PR
        if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ github.head_ref }}'.replace(/\//g, '-');
            const previewUrl = `https://${branch}.overture-maps.pages.dev`;
            const marker = '<!-- preview-comment -->';
            const body = `${marker}\nðŸš€ Preview deployed to: ${previewUrl}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              console.log('Preview comment already exists, skipping');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
